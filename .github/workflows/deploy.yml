name: Deploy to Server

on:
  repository_dispatch:
    types: [deploy]
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy'
        required: false
        default: 'latest'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: adventhymnals/advent-hymnals-web

permissions:
  contents: read

concurrency:
  group: "deploy-production"
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Extract deployment info
        id: info
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "image_tag=latest" >> $GITHUB_OUTPUT
            echo "triggered_by=build" >> $GITHUB_OUTPUT
            echo "sha=${{ github.event.client_payload.sha }}" >> $GITHUB_OUTPUT
          else
            echo "image_tag=${{ github.event.inputs.image_tag || 'latest' }}" >> $GITHUB_OUTPUT
            echo "triggered_by=manual" >> $GITHUB_OUTPUT
            echo "sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Verify Docker image exists
        run: |
          echo "🔍 Verifying Docker image exists..."
          
          # Login to check image availability
          echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          # Check if image exists and is pullable
          IMAGE_TAG="${{ steps.info.outputs.image_tag }}"
          IMAGE_URL="ghcr.io/adventhymnals/advent-hymnals-web:${IMAGE_TAG}"
          
          if docker manifest inspect "$IMAGE_URL" > /dev/null 2>&1; then
            echo "✅ Docker image $IMAGE_URL exists and is accessible"
          else
            echo "❌ Docker image $IMAGE_URL does not exist or is not accessible"
            echo "💡 This usually means the build workflow hasn't completed successfully yet."
            echo "🔍 Please ensure the build workflow has completed before running deployment."
            exit 1
          fi

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            # Change to deployment directory
            cd /opt/advent-hymnals
            
            echo "🚀 Starting deployment of Advent Hymnals..."
            echo "📦 Image: ghcr.io/adventhymnals/advent-hymnals-web:${{ steps.info.outputs.image_tag }}"
            echo "🔨 Triggered by: ${{ steps.info.outputs.triggered_by }}"
            echo "📝 SHA: ${{ steps.info.outputs.sha }}"
            
            # Update .env file with secrets
            cat > .env << EOF
            # Production Environment Variables for Advent Hymnals
            SITE_URL=https://adventhymnals.org
            NEXT_PUBLIC_SITE_URL=https://adventhymnals.org
            NODE_ENV=production
            
            # Analytics and Verification
            NEXT_PUBLIC_GA_ID=${{ secrets.NEXT_PUBLIC_GA_ID }}
            GOOGLE_VERIFICATION=${{ secrets.GOOGLE_VERIFICATION }}
            YANDEX_VERIFICATION=${{ secrets.YANDEX_VERIFICATION }}
            EOF
            
            # Ensure directories exist
            mkdir -p logs nginx/ssl data backups
            
            # Create external network if it doesn't exist
            if ! docker network ls | grep -q web-network; then
              echo "🌐 Creating external Docker network..."
              docker network create web-network
            fi
            
            # Login to GitHub Container Registry
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # Deploy the application (image existence already verified)
            echo "📦 Pulling latest Docker image..."
            docker pull ghcr.io/adventhymnals/advent-hymnals-web:${{ steps.info.outputs.image_tag }}
            
            echo "🛑 Stopping existing containers..."
            docker compose down || true
            
            echo "🚀 Starting new containers..."
            docker compose up -d
            
            echo "⏱️ Waiting for containers to start..."
            sleep 15
            
            echo "✅ Deployment completed successfully!"
            
            echo "🌐 Advent Hymnals is available at https://adventhymnals.org"

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            cd /opt/advent-hymnals
            
            echo "🔍 Performing post-deployment verification..."
            
            # Check container status
            echo "📊 Container Status:"
            docker compose ps
            
            # Check if any containers are running
            RUNNING_CONTAINERS=$(docker compose ps --format json | jq -r '.[] | select(.State == "running") | .Name' | wc -l)
            
            if [ "$RUNNING_CONTAINERS" -gt 0 ]; then
              echo "✅ Found $RUNNING_CONTAINERS running container(s)"
              
              # Test health endpoint
              echo "🏥 Testing health endpoint..."
              if curl -sf http://localhost/api/health > /dev/null 2>&1; then
                echo "✅ Health check passed - application is responding"
              else
                echo "⚠️ Health check failed - application may still be starting"
                echo "🔍 Container logs (last 10 lines):"
                docker compose logs --tail=10
              fi
              
              echo "ℹ️ SSL certificates can be set up using: ./scripts/setup-ssl.sh"
            else
              echo "❌ No containers are running"
              echo "🔍 Container status:"
              docker compose ps
              echo "🔍 Recent logs:"
              docker compose logs --tail=20
              exit 1
            fi
            
            echo "✅ Deployment verification completed successfully!"

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "✅ Deployment completed successfully!"
            echo "🌐 Site: https://adventhymnals.org"
            echo "📦 Image: ghcr.io/adventhymnals/advent-hymnals-web:${{ steps.info.outputs.image_tag }}"
          else
            echo "❌ Deployment failed!"
            echo "Please check the logs above for details."
            exit 1
          fi