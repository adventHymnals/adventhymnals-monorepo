name: Deploy to Server

on:
  repository_dispatch:
    types: [deploy]
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy'
        required: false
        default: 'latest'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: adventhymnals/advent-hymnals-web

permissions:
  contents: read

concurrency:
  group: "deploy-production"
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Extract deployment info
        id: info
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "image_tag=latest" >> $GITHUB_OUTPUT
            echo "triggered_by=build" >> $GITHUB_OUTPUT
            echo "sha=${{ github.event.client_payload.sha }}" >> $GITHUB_OUTPUT
          else
            echo "image_tag=${{ github.event.inputs.image_tag || 'latest' }}" >> $GITHUB_OUTPUT
            echo "triggered_by=manual" >> $GITHUB_OUTPUT
            echo "sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            # Change to deployment directory
            cd /opt/advent-hymnals
            
            echo "ğŸš€ Starting deployment of Advent Hymnals..."
            echo "ğŸ“¦ Image: ghcr.io/adventhymnals/advent-hymnals-web:${{ steps.info.outputs.image_tag }}"
            echo "ğŸ”¨ Triggered by: ${{ steps.info.outputs.triggered_by }}"
            echo "ğŸ“ SHA: ${{ steps.info.outputs.sha }}"
            
            # Update .env file with secrets
            cat > .env << EOF
            # Production Environment Variables for Advent Hymnals
            SITE_URL=https://adventhymnals.org
            NEXT_PUBLIC_SITE_URL=https://adventhymnals.org
            NODE_ENV=production
            
            # Analytics and Verification
            NEXT_PUBLIC_GA_ID=${{ secrets.NEXT_PUBLIC_GA_ID }}
            GOOGLE_VERIFICATION=${{ secrets.GOOGLE_VERIFICATION }}
            YANDEX_VERIFICATION=${{ secrets.YANDEX_VERIFICATION }}
            EOF
            
            # Ensure directories exist
            mkdir -p logs nginx/ssl data backups
            
            # Create external network if it doesn't exist
            if ! docker network ls | grep -q web-network; then
              echo "ğŸŒ Creating external Docker network..."
              docker network create web-network
            fi
            
            # Login to GitHub Container Registry
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # Use the robust deployment script
            if [[ -f "./scripts/deploy.sh" ]]; then
              echo "ğŸš€ Using comprehensive deployment script..."
              if ./scripts/deploy.sh update; then
                echo "âœ… Deployment script completed successfully"
              else
                echo "âŒ Deployment script failed, trying fallback method..."
                # Fallback deployment
                echo "ğŸ“¦ Attempting direct docker deployment..."
                if docker pull ghcr.io/adventhymnals/advent-hymnals-web:${{ steps.info.outputs.image_tag }}; then
                  docker compose down || true
                  docker compose up -d
                  sleep 15
                else
                  echo "âŒ Failed to pull Docker image. The image may not exist yet."
                  echo "ğŸ’¡ This can happen if the build workflow hasn't completed successfully."
                  echo "ğŸ” Please check that the build workflow has completed and the image is available in the registry."
                  exit 1
                fi
              fi
            else
              echo "ğŸ“¦ Using fallback deployment method..."
              if docker pull ghcr.io/adventhymnals/advent-hymnals-web:${{ steps.info.outputs.image_tag }}; then
                docker compose down || true
                docker compose up -d
                sleep 15
              else
                echo "âŒ Failed to pull Docker image and no deployment script found."
                echo "ğŸ’¡ Please ensure the build workflow has completed and the image is available."
                exit 1
              fi
            fi
            
            echo "ğŸŒ Advent Hymnals is available at https://adventhymnals.org"

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            cd /opt/advent-hymnals
            
            echo "ğŸ” Performing post-deployment verification..."
            
            # Check container status
            echo "ğŸ“Š Container Status:"
            docker compose ps
            
            # Check if containers are running
            if docker compose ps --format json | jq -e '.[] | select(.State == "running")' > /dev/null 2>&1; then
              echo "ğŸ¥ Health Check:"
              if curl -sf http://localhost/api/health > /dev/null 2>&1; then
                echo "âœ… Internal health check passed"
              else
                echo "âŒ Internal health check failed"
                echo "ğŸ” Checking container logs..."
                docker compose logs --tail=10
                exit 1
              fi
              
              # Only check HTTPS if nginx container is running and we're not in certificate acquisition mode
              if docker compose ps nginx --format json | jq -e '.State == "running"' > /dev/null 2>&1; then
                echo "â„¹ï¸ HTTPS Check skipped - certificates should be managed separately via scripts/setup-ssl.sh"
              else
                echo "âš ï¸ Nginx container not running"
              fi
            else
              echo "âŒ No containers are running"
              echo "ğŸ” Checking compose configuration..."
              docker compose config --quiet || echo "âŒ Docker compose configuration is invalid"
              exit 1
            fi
            
            echo "âœ… Deployment verification completed successfully!"

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… Deployment completed successfully!"
            echo "ğŸŒ Site: https://adventhymnals.org"
            echo "ğŸ“¦ Image: ghcr.io/adventhymnals/advent-hymnals-web:${{ steps.info.outputs.image_tag }}"
          else
            echo "âŒ Deployment failed!"
            echo "Please check the logs above for details."
            exit 1
          fi