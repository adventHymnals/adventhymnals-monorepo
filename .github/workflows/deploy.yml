name: Deploy to Server

on:
  repository_dispatch:
    types: [deploy]
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy'
        required: false
        default: 'latest'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: adventhymnals/advent-hymnals-web

permissions:
  contents: read

concurrency:
  group: "deploy-production"
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Extract deployment info
        id: info
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "image_tag=latest" >> $GITHUB_OUTPUT
            echo "triggered_by=build" >> $GITHUB_OUTPUT
            echo "sha=${{ github.event.client_payload.sha }}" >> $GITHUB_OUTPUT
          else
            echo "image_tag=${{ github.event.inputs.image_tag || 'latest' }}" >> $GITHUB_OUTPUT
            echo "triggered_by=manual" >> $GITHUB_OUTPUT
            echo "sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Verify Docker image exists
        run: |
          echo "ğŸ” Verifying Docker image exists..."
          
          # Login to check image availability
          echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          # Check if image exists and is pullable
          IMAGE_TAG="${{ steps.info.outputs.image_tag }}"
          IMAGE_URL="ghcr.io/adventhymnals/advent-hymnals-web:${IMAGE_TAG}"
          
          if docker manifest inspect "$IMAGE_URL" > /dev/null 2>&1; then
            echo "âœ… Docker image $IMAGE_URL exists and is accessible"
          else
            echo "âŒ Docker image $IMAGE_URL does not exist or is not accessible"
            echo "ğŸ’¡ This usually means the build workflow hasn't completed successfully yet."
            echo "ğŸ” Please ensure the build workflow has completed before running deployment."
            exit 1
          fi

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            # Change to deployment directory
            cd /opt/advent-hymnals
            
            echo "ğŸš€ Starting deployment of Advent Hymnals..."
            echo "ğŸ“¦ Image: ghcr.io/adventhymnals/advent-hymnals-web:${{ steps.info.outputs.image_tag }}"
            echo "ğŸ”¨ Triggered by: ${{ steps.info.outputs.triggered_by }}"
            echo "ğŸ“ SHA: ${{ steps.info.outputs.sha }}"
            
            # Update .env file with secrets
            cat > .env << EOF
            # Production Environment Variables for Advent Hymnals
            SITE_URL=https://adventhymnals.org
            NEXT_PUBLIC_SITE_URL=https://adventhymnals.org
            NODE_ENV=production
            
            # Analytics and Verification
            NEXT_PUBLIC_GA_ID=${{ secrets.NEXT_PUBLIC_GA_ID }}
            GOOGLE_VERIFICATION=${{ secrets.GOOGLE_VERIFICATION }}
            YANDEX_VERIFICATION=${{ secrets.YANDEX_VERIFICATION }}
            EOF
            
            # Ensure directories exist
            mkdir -p logs nginx/ssl data backups
            
            # Create external network if it doesn't exist
            if ! docker network ls | grep -q web-network; then
              echo "ğŸŒ Creating external Docker network..."
              docker network create web-network
            fi
            
            # Login to GitHub Container Registry
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # Deploy the application (image existence already verified)
            echo "ğŸ“¦ Pulling latest Docker image..."
            docker pull ghcr.io/adventhymnals/advent-hymnals-web:${{ steps.info.outputs.image_tag }}
            
            echo "ğŸ›‘ Stopping existing containers..."
            docker compose down || true
            
            echo "ğŸš€ Starting new containers..."
            docker compose up -d
            
            echo "â±ï¸ Waiting for containers to start..."
            sleep 15
            
            echo "âœ… Deployment completed successfully!"
            
            echo "ğŸŒ Advent Hymnals is available at https://adventhymnals.org"

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            cd /opt/advent-hymnals
            
            echo "ğŸ” Performing post-deployment verification..."
            
            # Check container status
            echo "ğŸ“Š Container Status:"
            docker compose ps
            
            # Check if any containers are running
            RUNNING_CONTAINERS=$(docker compose ps --format json | jq -r '.[] | select(.State == "running") | .Name' | wc -l)
            
            if [ "$RUNNING_CONTAINERS" -gt 0 ]; then
              echo "âœ… Found $RUNNING_CONTAINERS running container(s)"
              
              # Test health endpoint
              echo "ğŸ¥ Testing health endpoint..."
              if curl -sf http://localhost/api/health > /dev/null 2>&1; then
                echo "âœ… Health check passed - application is responding"
              else
                echo "âš ï¸ Health check failed - application may still be starting"
                echo "ğŸ” Container logs (last 10 lines):"
                docker compose logs --tail=10
              fi
              
              echo "â„¹ï¸ SSL certificates can be set up using: ./scripts/setup-ssl.sh"
            else
              echo "âŒ No containers are running"
              echo "ğŸ” Container status:"
              docker compose ps
              echo "ğŸ” Recent logs:"
              docker compose logs --tail=20
              exit 1
            fi
            
            echo "âœ… Deployment verification completed successfully!"

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… Deployment completed successfully!"
            echo "ğŸŒ Site: https://adventhymnals.org"
            echo "ğŸ“¦ Image: ghcr.io/adventhymnals/advent-hymnals-web:${{ steps.info.outputs.image_tag }}"
          else
            echo "âŒ Deployment failed!"
            echo "Please check the logs above for details."
            exit 1
          fi